name: Salesforce CI/CD Pipeline

# 1️⃣ Manual trigger with inputs (UI)
on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Branch to deploy from'
        required: true
        default: 'feature/my-feature'
      target_branch:
        description: 'Branch to deploy to'
        required: true
        default: 'main'

jobs:
  deploy-to-sandbox:
    runs-on: ubuntu-latest

    steps:
      # 2️⃣ Checkout the selected source branch
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.source_branch }}

      # 3️⃣ Install Salesforce CLI
      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      # 4️⃣ Authenticate to Salesforce using JWT
      - name: Authenticate Salesforce Org
        run: |
          echo "${{ secrets.SF_JWT_KEY }}" > server.key
          sf org login jwt \
            --client-id ${{ secrets.SF_CLIENT_ID }} \
            --jwt-key-file server.key \
            --username ${{ secrets.SF_USERNAME }} \
            --instance-url ${{ secrets.SF_INSTANCE_URL }} \
            --alias TargetSandbox

      # 5️⃣ Validate deployment using package.xml
      - name: Validate Deployment
        run: |
          sf project deploy validate \
            --target-org TargetSandbox \
            --manifest manifest/package.xml \
            --test-level RunLocalTests

      # 6️⃣ Deploy to sandbox using package.xml
      - name: Deploy to Sandbox
        run: |
          sf project deploy start \
            --target-org TargetSandbox \
            --manifest manifest/package.xml \
            --test-level RunLocalTests
